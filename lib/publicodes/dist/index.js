!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n(require("nearley"),require("yaml"),require("moo")):"function"==typeof define&&define.amd?define(["nearley","yaml","moo"],n):"object"==typeof exports?exports.publicodes=n(require("nearley"),require("yaml"),require("moo")):e.publicodes=n(e.nearley,e.yaml,e.moo)}(this,(function(e,n,t){return function(e){var n={};function t(r){if(n[r])return n[r].exports;var a=n[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,t),a.l=!0,a.exports}return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var a in e)t.d(r,a,function(n){return e[n]}.bind(null,a));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=9)}([function(e,n,t){"use strict";t.d(n,"g",(function(){return l})),t.d(n,"f",(function(){return s})),t.d(n,"b",(function(){return c})),t.d(n,"h",(function(){return p})),t.d(n,"e",(function(){return d})),t.d(n,"i",(function(){return m})),t.d(n,"c",(function(){return f})),t.d(n,"a",(function(){return b})),t.d(n,"d",(function(){return v})),t.d(n,"k",(function(){return O})),t.d(n,"j",(function(){return g}));var r=t(1);function a(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){u(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function u(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=["depuis","depuis le","depuis la","à partir de","à partir du","du"],r=["jusqu'à","jusqu'au","jusqu'à la","avant","avant le","avant la","au"];if(!t.concat(r,["le","en"]).includes(e))throw new SyntaxError("Le mot clé '".concat(e,"' n'est pas valide. Les mots clés possible sont les suivants :\n\t ").concat(t.join(", ")));if("le"===e)return{start:n,end:n};if("en"===e)return{start:null,end:null};if(t.includes(e))return{start:n,end:null};if(r.includes(e))return{start:null,end:n};throw new Error("Non implémenté")}function s(e,n){return f((e,n)=>n&&e,n,c(!0,e))}function c(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{start:null,end:null},t=[o(o({},n),{},{value:e})];return null!=n.start&&t.unshift({start:null,end:Object(r.f)(n.start,-1),value:!1}),null!=n.end&&t.push({start:Object(r.f)(n.end,1),end:null,value:!1}),t}function p(e){return[{start:null,end:null,value:e}]}function d(e,n){return n.map(n=>{var{start:t,end:r,value:a}=n;return{start:t,end:r,value:e(a)}})}function m(e,n){return n.some(n=>{var{start:t,end:r,value:a}=n;return e(a)})}function f(e,n,t){return d(n=>{var[t,r]=n;return e(t,r)},O(n,t))}function b(e){return e.reduce((e,n)=>f((e,n)=>[...e,n],e,n),p([]))}function v(e){if(!("temporalValue"in e))return p(e);var n=e,{temporalValue:t}=n,r=a(n,["temporalValue"]);return d(e=>o(o({},r),{},{nodeValue:e}),t)}function O(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(!e.length&&!n.length)return t;var[a,...i]=e,[u,...l]=n;console.assert(a.start===u.start);var s=y(a.end,u.end);if(0===s)return O(i,l,[...t,o(o({},a),{},{value:[a.value,u.value]})]);if(s>0)return console.assert(null!==u.end),O([o(o({},a),{},{start:Object(r.f)(u.end,1)}),...i],l,[...t,o(o({},u),{},{value:[a.value,u.value]})]);if(s<0)return console.assert(null!==a.end),O(i,[o(o({},u),{},{start:Object(r.f)(a.end,1)}),...l],[...t,o(o({},a),{},{value:[a.value,u.value]})]);throw new EvalError("All case should have been covered")}function y(e,n){return e==n?0:null==e?1:null==n||Object(r.a)(e)<Object(r.a)(n)?-1:1}function g(e,n){if(!(e=e.filter(e=>{var{value:n}=e;return!1!==n})).length)return!1;if(1===e.length)return e[0].value;if(e.some(e=>{var{value:n}=e;return null==n}))return null;var t=e,a=t[0],i=t[t.length-1];if(null==a.start||null==i.end)return null!=a.start?i.value:null!=i.end?a.value:(a.value+i.value)/2;var o=0;return t.map(e=>{var{start:t,end:a,value:i}=e;[t,a]=[t,a];var u=0;return u=(null==n?void 0:n.denominators.includes("mois"))?Object(r.d)(t,a):(null==n?void 0:n.denominators.includes("année"))?Object(r.e)(t,a):Object(r.c)(t,a),o+=u,i*u}).reduce((e,n)=>e+n/o,0)}},function(e,n,t){"use strict";function r(e){var[n,t,r]=e.split("/");return r||([n,t,r]=["01",n,t]),i(+r,+t,+n)}t.d(n,"h",(function(){return r})),t.d(n,"a",(function(){return o})),t.d(n,"b",(function(){return u})),t.d(n,"f",(function(){return l})),t.d(n,"g",(function(){return s})),t.d(n,"c",(function(){return c})),t.d(n,"d",(function(){return p})),t.d(n,"e",(function(){return d}));var a=e=>+e<10?"0".concat(e):""+e;function i(e,n,t){var r=new Date(+e,+n-1,+t);if(!+r||r.getDate()!==+t)throw new SyntaxError("La date ".concat(t,"/").concat(n,"/").concat(e," n'est pas valide"));return"".concat(a(t),"/").concat(a(n),"/").concat(a(e))}function o(e){var[n,t,a]=r(e).split("/"),i=new Date(+a,+t-1,+n);return i.setMinutes(i.getMinutes()-i.getTimezoneOffset()),i}function u(e){return i(e.getFullYear(),e.getMonth()+1,e.getDate())}function l(e,n){var t=new Date(o(e));return t.setDate(t.getDate()+n),u(t)}function s(e){return+e.slice(-4)}function c(e,n){return 1+(o(e).getTime()-o(n).getTime())/864e5}function p(e,n){var[t,r,a]=e.split("/").map(e=>+e),[i,o,u]=n.split("/").map(e=>+e);return o-r+12*(u-a)-(t-1)/new Date(a,r,0).getDate()+i/new Date(u,o,0).getDate()}function d(e,n){return c(e,n)/365.25}},function(e,n){},function(n,t){n.exports=e},function(e,n){e.exports={"applicable si":{chainable:"oui",description:"Renvoie `non` si la condition est égale à `non`. Renvoie la valeur sinon.\nPermet de désactiver une règle ou une valeur. ",retourne:"Valeur | non",exemples:{base:"ancienneté: 4 mois prime de vacances:\n  applicable si: ancienneté >= 1 an\n  valeur: 200€"}},"non applicable si":{chainable:"oui",description:"Renvoit `non` si la condition n'est pas égale à `non`\nPermet de désactiver une règle ou une valeur. ",retourne:"Valeur | non",exemples:{base:"ancienneté: 4 mois prime de vacances:\n  non applicable si: ancienneté < 1 an\n  valeur: 200€"}},"une de ces conditions":{description:"Renvoie `oui` si l'une des règles listées est _applicable_.\n\nEquivaut à un `ou` logique.",retourne:"Booléen",exemples:{base:"âge: 17 ans mineur émancipé: oui peut voter:\n  une de ces conditions:\n    - âge >= 18 ans\n    - mineur émancipé"}},"toutes ces conditions":{description:"Renvoie `oui` si toutes toutes les règles listées sont _applicables_.\n\nEquivaut à un `et` logique.",argument:["*","..."],exemples:{base:"âge: 17 ans citoyenneté française: oui peut voter:\n  toutes ces conditions:\n    - citoyenneté française\n    - âge >= 18 ans"}},produit:{description:"C'est une multiplication adaptée pour exprimer au mieux les cotisations.\n\nSa propriété `assiette` est multipliée par un pourcentage `taux`, ou par un `facteur` quand ce nom est plus approprié.\n\nLa multiplication peut être plafonnée : ce plafond sépare l'assiette en deux, et la partie au-dessus du plafond est tout simplement ignorée. Dans ce cas, elle se comporte comme une barème en taux marginaux à deux tranches, la deuxième au taux nul et allant de `plafond` à l'infini.",argument:{assiette:"Valeur à multiplier",taux:"Taux à appliquer",facteur:"Facteur multiplicatif",plafond:"Plafond au dessus duquel le taux appliqué est nul"},exemples:{base:"cotisation:\n  produit:\n    assiette: 2000 €/mois\n    taux: 5%","assiette plafonnée":"plafond sécurité sociale: 3000 €/mois assiette cotisation: 15000 €/mois chômage:\n  produit:\n    assiette: assiette cotisation\n    plafond: 400% * plafond sécurité sociale\n    taux: 4%"}},variations:{description:"Contient une liste de conditions (`si`) et leurs conséquences associées (`alors`), ainsi qu'un cas par défaut (`sinon`).\n\nPour la première condition vraie dans la liste, on retient la valeur qui lui est associée.\n\nSi aucune condition n'est vraie, alors ce mécanisme renvoie implicitement `non`.\n\nCe mécanisme peut aussi être utilisé au sein d'un autre mécanisme avec des attributs,  tel que `produit` ou `barème`.",arguments:[{si:"condition à vérifier",alors:"consequence évaluée si la condition est vrai"},"...",{sinon:"consequence évaluée si aucune des conditions précédente n'était applicable"}],exemples:{base:"taux réduit: oui\ntaux allocation familiales:\n  variations:\n    - si: taux réduit\n      alors: 3.45%\n    - sinon: 5.25%","dans un produit":"assiette cotisation: 2300 €/mois\ntaux réduit: oui\nallocation familiales:\n  produit:\n    assiette: assiette cotisation\n    variations:\n      - si: taux réduit\n        alors:\n          taux: 3.45%\n      - sinon:\n          taux: 5.25%"}},somme:{description:"Somme de chaque terme de la liste.\n\nSi un des terme n'est pas applicable, il vaut zéro.\n\nOn peut retrancher des valeurs grâce à l'opérateur unaire `-`",arguments:["*","..."],exemples:{base:"exemple:\n  somme:\n    - 15.89 €\n    - 12% * 14 €\n    - (-20 €)","terme non applicable":"a: 50 € b:\n  applicable si: non\n  valeur: 20 €\n\nsomme:\n  somme:\n    - a\n    - b\n    - 40 €"}},"le maximum de":{description:"Renvoie la valeur numérique de la liste de propositions fournie qui est la plus grande.\n\nPour ajouter un plancher à une valeur, préférer l'utilisation du mécanisme `encadrement`.",exemples:{base:"max: \n  le maximum de:\n    - 50\n    - 100"}},"le minimum de":{description:"Renvoie la valeur numérique de la liste de propositions fournie qui est la plus petite.\n\nPour plafonner une valeur, préférer l'utilisation du mécanisme `encadrement`.",exemples:{base:"min: \n  le minimum de:\n    - 50\n    - 100"}},arrondi:{chainable:"oui",description:"Arrondi à l'entier le plus proche, ou à une précision donnée.",exemples:{base:"arrondi:\n  arrondi: oui\n  valeur: 12.45","nombre de décimales":"arrondi:\n  arrondi: 2 décimales\n  valeur: 2/3"}},recalcul:{description:"Relance le calcul d'une règle dans une situation différente de la situation courante. Permet par exemple de calculer le montant des cotisations au niveau du SMIC, même si le salaire est plus élevé dans la situation actuelle.",exemples:{base:"brut: 2000€\ncotisations:\n  produit:\n    assiette: brut\n    taux: 20%\n\ncotisations pour un SMIC:\n  recalcul:\n    règle: cotisations\n    avec:\n      brut: 1500 €"}},"barème":{description:"C'est un barème en taux marginaux, mécanisme de calcul connu de par son utilisation dans le calcul de l'impôt sur le revenu.\nL'assiette est décomposée en plusieurs tranches, qui sont multipliées par un taux spécifique et enfin additionnées pour donner le résultat.\nLes tranches sont souvent exprimées sous forme de facteurs d'une variable que l'on appelle `multiplicateur`, par exemple une fois le plafond de la sécurité sociale.",exemples:{"sans multiplicateur":"revenu imposable: 54126 € impôt sur le revenu:\n  barème:\n    assiette: revenu imposable\n    tranches:\n      - taux: 0%\n        plafond: 9807 €\n      - taux: 14%\n        plafond: 27086 €\n      - taux: 30%\n        plafond: 72617 €\n      - taux: 41%\n        plafond: 153783 €\n      - taux: 45%","avec multiplicateur":"retraite de base:\n  barème:\n    assiette: assiette retraite\n    multiplicateur: plafond sécurité sociale temps plein\n    tranches:\n      - taux: 17.75%\n        plafond: 1\n      - taux: 0.6%\n  arrondi: oui"}},grille:{description:"C'est un barème sous la forme d'une grille de correspondance simple. C'est le mécanisme de calcul de l'impôt neutre, aussi appelé impôt non personnalisé.\nIl est composé de tranches qui se suivent. Il suffit de trouver l'assiette qui correspond à la tranche, et de selectionner le montant associé à l'assiette.",exemples:{"grille avec multiplicateur et unité":"SMIC horaire: 10 €/heure revenu moyen: 1200€/an trimestres validés:\n  grille:\n    unité: trimestres validés/an\n    assiette: revenu moyen\n    multiplicateur: SMIC horaire\n    tranches:\n      - montant: 0\n        plafond: 150 heures/an\n      - montant: 1\n        plafond: 300 heures/an\n      - montant: 2\n        plafond: 450 heures/an\n      - montant: 3\n        plafond: 600 heures/an\n      - montant: 4"}},"taux progressif":{description:"Ce mécanisme permet de calculer un taux progressif. On spécifie pour chaque tranche le plafond et le taux associé. Le taux effectif renvoyé est calculé en lissant la différence de taux entre la borne inférieure et supérieure de l'assiette.\n\nPar exemple, si nous nous avons les tranches suivantes :\n\n- taux: 50% / plafond: 0\n- taux: 100% / plafond: 1000\n\nPour une assiette de 500, le taux retourné sera 75%, car il correspond au taux situé à la moitié de la tranche correspondante.",exemples:{base:"chiffre d'affaires: 30000 €/an plafond: 3000 €/mois taux réduction de cotisation:\n  taux progressif:\n    assiette: chiffre d'affaires\n    multiplicateur: plafond\n    tranches:\n      - taux: 100%\n        plafond: 75%\n      - taux: 0%\n        plafond: 100%"}},composantes:{description:"Beaucoup de cotisations sont composées de deux parties qui partagent la méthode de calcul mais diffèrent selons certains paramètres. Pour ne pas définir deux variables quasi-redondantes, on utilise ce mécanisme.\nCela permet d'avoir une écriture factorisée, plus facile à lire. \nDans les calculs, `composantes` se comporte **exactement comme une somme**. La documentation, elle, sera adaptée pour montrer chaque composantes.\nIl est possible par exemple pour le mécanisme `produit` de garder en commun l'assiette, et de déclarer des composantes pour le taux.\nChaque composante peut également contenir un champs `attributs` de type objet contenant les mécanismes chainés à appliquer à la composante en question\nLorsque l'on utilise l'attribut `nom`, cela abouti à la définition de règles  imbriquées pour chacun des terme de la somme.\n ",exemples:{base:"composante:\n  produit:\n    assiette: assiette de base\n    composantes:\n      - taux: 2%\n      - taux: 4%\n        plafond: plafond sécurité sociale",Cotisations:"cotisation 1:\n  produit:\n    assiette: assiette de base\n    composantes:\n      - attributs:\n          nom: employeur\n        taux: 5%\n      - attributs:\n          nom: salarié\n        taux: 1%\n\ncotisations salariales :\n  somme: \n    - cotisation 1 . salarié\n    # ...",TVA:"prix:\n  produit:\n    assiette: 50€\n    composantes:\n      - attributs:\n          nom: HT\n      - attributs:\n          nom: TVA\n        taux: 20%\n\nvérification:\n  prix = prix . HT + prix . TVA "}},abattement:{chainable:"oui",description:"Permet de réduire le montant d'une valeur.\nLe résultat vaudra toujours au moins zéro, y compris quand le montant de l'abattement est plus grand que le montant abattu.\nIl est possible d'utiliser le mécanisme `abattement` de deux manières :\n  - soit en indiquant un montant de la même unité que la valeur, qui lui sera alors soustrait\n  - soit en indiquant un pourcentage qui sera utilisé pour calculer l'abattement de manière relative",exemples:{"abattement simple":"revenu imposable:\n  valeur: 10000€\n  abattement: 2000€","abattement supérieur à la valeur":"revenu imposable:\n  valeur: 1000€\n  abattement: 2000€","abattement relatif":"revenu imposable:\n  valeur: 2000€\n  abattement: 10%"}},plancher:{chainable:"oui",description:"Permet d'ajouter un plancher à une valeur.",exemples:{base:"revenus: -500€ assiette des cotisations:\n  valeur: revenus\n  plancher: 0 €"}},plafond:{chainable:"oui",description:"Permet de plafonner une valeur.",exemples:{base:"salaire: 1300€/mois déduction fiscale:\n  valeur: salaire * 10%\n  plafond: 5000 €/an"}},"durée":{description:"Permet d'obtenir le nombre de jours entre deux dates",exemples:{base:"date d'embauche: 14/04/2008 ancienneté en fin d'année:\n  unité: an\n  durée:\n    depuis: date d'embauche\n    jusqu'à: 31/12/2020"}},"unité":{chainable:"oui",description:"Permet de convertir explicitement une unité.\n\nAffiche un avertissement si la conversion n'est pas possible à cause d'unités incompatibles.\n",exemples:{base:"salaire: \n  valeur: 35 k€/an\n  unité: €/mois"}},"par défaut":{chainable:"oui",description:"Permet de donner une valeur par défaut pour le calcul, sans influer sur les variables manquantes retournés.\n\nUtile dans le cas d'une situation incomplète où l'on veut quand même retourner une première estimation.\n",exemples:{base:"prix TTC: \n  assiette: prix HT * (100% + TVA)\nTVA: \n  par défaut: 20%"}},synchronisation:{description:"Permet de récupérer certaines informations, tels que les les codes postaux des villes, à partir d'APIs externes, telles que l'[API commune](https://geo.api.gouv.fr/decoupage-administratif/communes).\n\nAttention, ce mécanisme est encore en cours de développement, et sa syntaxe n'est pas stable. Se référer aux exemples existants."},"inversion numérique":{description:"Il est souhaitable de rédiger les règles de calcul en publicodes de la même façon qu'elles sont décrites dans la loi ou les interprétations administratives ou juridiques existantes. En conséquence, certaines variables n'auront donc pas de méthode de calcul clairement explicitée, il s'agira donc de la déduire des autres valeurs renseignées.\n\nDe façon simplifiée, il s'agira donc, à partir d'une règle existante explicitant `y = ƒ(x)` de calculer `x` à partir de `y`.\n\nL'inversion numérique permet d'estimer la valeur de la variable en question au plus près à partir d'un des _objectifs_, listés dans la propriété `avec`. Il faut alors renseigner une valeur cible pour ces objectifs.\n\nL'algorithme utilisé est la [méthode de Brent](https://fr.wikipedia.org/wiki/M%C3%A9thode_de_Brent). L'idée générale est de prendre une valeur au hasard pour la variable en question, et d'améliorer mathématiquement le choix jusqu'à ce que les valeurs cibles soient toutes suffisamment proches des objectifs\n\nSi on demande au moteur la valeur d'une variable qui a pour formule une inversion, il va vérifier qu'une des variables `avec` a bien une valeur (calculée ou saisie), et procéder à l'inversion décrite plus haut à partir de celle-ci. Sinon, ces possibilités d'inversions seront listées comme manquantes."}}},function(e,n,t){!function(){function n(e){return e[0]}var{string:r,date:a,variable:i,temporalNumericValue:o,binaryOperation:u,unaryOperation:l,boolean:s,number:c,numberWithUnit:p,JSONObject:d}=t(7),m=t(8),f="".concat("[a-zA-ZÀ-ſ€$%]","(?:[-']?").concat("[a-zA-ZÀ-ſ0-9'°]","+)*"),b="(?:".concat(f,"|").concat("[a-zA-ZÀ-ſ0-9'°]","+)"),v="".concat(f,"(?:[,\\s]?").concat(b,"+)*"),O="\\| ".concat(f,"(?:[\\s]").concat(f,")*"),y=m.compile({"(":"(",")":")","[":"[","]":"]",comparison:[">","<",">=","<=","=","!="],infinity:"Infinity",colon:" : ",date:new RegExp("(?:(?:0?[1-9]|[12][0-9]|3[01])\\/)?(?:0?[1-9]|1[012])\\/\\d{4}"),periodWord:new RegExp(O),words:new RegExp(v),number:new RegExp("-?(?:[1-9][0-9]+|[0-9])(?:\\.[0-9]+)?"),string:/'.*'/,JSONObject:/{.*}/,additionSubstraction:/[\+-]/,multiplicationDivision:["*","/"],dot:" . ",".":".",letterOrNumber:new RegExp("[a-zA-ZÀ-ſ0-9'°]"),space:{match:/[\s]+/,lineBreaks:!0}}),g=e=>({value:e.map(e=>e&&e.value).join("")}),h=e=>{var[n,t]=e;return Array.isArray(t)?g([n,...t]):n},j={Lexer:y,ParserRules:[{name:"main",symbols:["Comparison"],postprocess:n},{name:"main",symbols:["NumericValue"],postprocess:n},{name:"main",symbols:["Date"],postprocess:n},{name:"main",symbols:["NonNumericTerminal"],postprocess:n},{name:"main",symbols:["JSONObject"],postprocess:n},{name:"NumericValue",symbols:["AdditionSubstraction"],postprocess:n},{name:"NumericValue",symbols:["Negation"],postprocess:n},{name:"NumericValue",symbols:["TemporalNumericValue"],postprocess:n},{name:"TemporalNumericValue",symbols:["NumericValue",y.has("space")?{type:"space"}:space,y.has("periodWord")?{type:"periodWord"}:O,y.has("space")?{type:"space"}:space,y.has("date")?{type:"date"}:a],postprocess:e=>{var[n,,t,,r]=e;return o(n,t,a([r]))}},{name:"TemporalNumericValue",symbols:["NumericValue",y.has("space")?{type:"space"}:space,y.has("periodWord")?{type:"periodWord"}:O,y.has("colon")?{type:"colon"}:colon,"Date"],postprocess:e=>{var[n,,t,,r]=e;return o(n,t,r)}},{name:"NumericTerminal",symbols:["Variable"],postprocess:n},{name:"NumericTerminal",symbols:["number"],postprocess:n},{name:"Negation",symbols:[{literal:"-"},y.has("space")?{type:"space"}:space,"Parentheses"],postprocess:l("calculation")},{name:"Parentheses",symbols:[{literal:"("},"NumericValue",{literal:")"}],postprocess:e=>{var[,n]=e;return n}},{name:"Parentheses",symbols:["NumericTerminal"],postprocess:n},{name:"Date",symbols:["Variable"],postprocess:n},{name:"Date",symbols:[y.has("date")?{type:"date"}:a],postprocess:a},{name:"Comparison",symbols:["Comparable",y.has("space")?{type:"space"}:space,y.has("comparison")?{type:"comparison"}:comparison,y.has("space")?{type:"space"}:space,"Comparable"],postprocess:u("comparison")},{name:"Comparison",symbols:["Date",y.has("space")?{type:"space"}:space,y.has("comparison")?{type:"comparison"}:comparison,y.has("space")?{type:"space"}:space,"Date"],postprocess:u("comparison")},{name:"Comparable$subexpression$1",symbols:["AdditionSubstraction"]},{name:"Comparable$subexpression$1",symbols:["NonNumericTerminal"]},{name:"Comparable",symbols:["Comparable$subexpression$1"],postprocess:e=>{var[[n]]=e;return n}},{name:"NonNumericTerminal",symbols:["boolean"],postprocess:n},{name:"NonNumericTerminal",symbols:["string"],postprocess:n},{name:"Variable$ebnf$1",symbols:[]},{name:"Variable$ebnf$1$subexpression$1",symbols:[y.has("dot")?{type:"dot"}:dot,y.has("words")?{type:"words"}:v],postprocess:e=>{var[,n]=e;return n}},{name:"Variable$ebnf$1",symbols:["Variable$ebnf$1","Variable$ebnf$1$subexpression$1"],postprocess:function(e){return e[0].concat([e[1]])}},{name:"Variable",symbols:[y.has("words")?{type:"words"}:v,"Variable$ebnf$1"],postprocess:i},{name:"UnitDenominator$ebnf$1$subexpression$1",symbols:[y.has("space")?{type:"space"}:space]},{name:"UnitDenominator$ebnf$1",symbols:["UnitDenominator$ebnf$1$subexpression$1"],postprocess:n},{name:"UnitDenominator$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"UnitDenominator",symbols:["UnitDenominator$ebnf$1",{literal:"/"},y.has("words")?{type:"words"}:v],postprocess:g},{name:"UnitNumerator$ebnf$1$subexpression$1",symbols:[{literal:"."},y.has("words")?{type:"words"}:v]},{name:"UnitNumerator$ebnf$1",symbols:["UnitNumerator$ebnf$1$subexpression$1"],postprocess:n},{name:"UnitNumerator$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"UnitNumerator",symbols:[y.has("words")?{type:"words"}:v,"UnitNumerator$ebnf$1"],postprocess:h},{name:"Unit$ebnf$1",symbols:["UnitNumerator"],postprocess:n},{name:"Unit$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"Unit$ebnf$2",symbols:[]},{name:"Unit$ebnf$2",symbols:["Unit$ebnf$2","UnitDenominator"],postprocess:function(e){return e[0].concat([e[1]])}},{name:"Unit",symbols:["Unit$ebnf$1","Unit$ebnf$2"],postprocess:h},{name:"AdditionSubstraction",symbols:["AdditionSubstraction",y.has("space")?{type:"space"}:space,y.has("additionSubstraction")?{type:"additionSubstraction"}:additionSubstraction,y.has("space")?{type:"space"}:space,"MultiplicationDivision"],postprocess:u("calculation")},{name:"AdditionSubstraction",symbols:["MultiplicationDivision"],postprocess:n},{name:"MultiplicationDivision",symbols:["MultiplicationDivision",y.has("space")?{type:"space"}:space,y.has("multiplicationDivision")?{type:"multiplicationDivision"}:multiplicationDivision,y.has("space")?{type:"space"}:space,"Parentheses"],postprocess:u("calculation")},{name:"MultiplicationDivision",symbols:["Parentheses"],postprocess:n},{name:"boolean",symbols:[{literal:"oui"}],postprocess:s(!0)},{name:"boolean",symbols:[{literal:"non"}],postprocess:s(!1)},{name:"number",symbols:[y.has("number")?{type:"number"}:c],postprocess:c},{name:"number",symbols:[y.has("infinity")?{type:"infinity"}:infinity],postprocess:c},{name:"number$ebnf$1$subexpression$1",symbols:[y.has("space")?{type:"space"}:space]},{name:"number$ebnf$1",symbols:["number$ebnf$1$subexpression$1"],postprocess:n},{name:"number$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"number",symbols:[y.has("number")?{type:"number"}:c,"number$ebnf$1","Unit"],postprocess:p},{name:"string",symbols:[y.has("string")?{type:"string"}:r],postprocess:r},{name:"JSONObject",symbols:[y.has("JSONObject")?{type:"JSONObject"}:d],postprocess:d}],ParserStart:"main"};void 0!==e.exports?e.exports=j:window.grammar=j}()},function(e,t){e.exports=n},function(e,n,t){"use strict";t.r(n),t.d(n,"binaryOperation",(function(){return l})),t.d(n,"unaryOperation",(function(){return s})),t.d(n,"temporalNumericValue",(function(){return c})),t.d(n,"variable",(function(){return p})),t.d(n,"JSONObject",(function(){return d})),t.d(n,"number",(function(){return m})),t.d(n,"numberWithUnit",(function(){return f})),t.d(n,"date",(function(){return b})),t.d(n,"boolean",(function(){return v})),t.d(n,"string",(function(){return O}));var r=t(1),a=t(0);function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){u(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function u(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}var l=e=>n=>{var[t,,r,,a]=n;return{[r]:{operationType:e,explanation:[t,a]}}},s=e=>n=>{var[t,,r]=n;return{[t]:{operationType:e,explanation:[m([{value:"0"}]),r]}}},c=(e,n,t)=>({temporalValue:{explanation:e,period:Object(a.g)(n.value.slice(2),t)}}),p=(e,n,t)=>{var[r,a]=e,i=[r,...a].map(e=>{var{value:n}=e;return n});return!a.length&&["oui","non"].includes(r)?t:{variable:i.join(" . ")}},d=e=>{var[{value:n}]=e;console.log(n)},m=e=>{var[{value:n}]=e;return{constant:{type:"number",nodeValue:parseFloat(n)}}},f=e=>o(o({},m(e)),{},{"unité":e[2].value}),b=e=>{var[{value:n}]=e;return{constant:{type:"date",nodeValue:Object(r.h)(n)}}},v=e=>()=>({constant:{type:"boolean",nodeValue:e}}),O=e=>{var[{value:n}]=e;return{constant:{type:"string",nodeValue:n.slice(1,-1)}}}},function(e,n){e.exports=t},function(e,n,t){"use strict";t.r(n),t.d(n,"mecanismsDoc",(function(){return sr.a})),t.d(n,"reduceAST",(function(){return d})),t.d(n,"transformAST",(function(){return p})),t.d(n,"Evaluation",(function(){return U.Evaluation})),t.d(n,"Unit",(function(){return U.Unit})),t.d(n,"capitalise0",(function(){return Ut})),t.d(n,"formatValue",(function(){return Mt})),t.d(n,"simplifyNodeUnit",(function(){return fe})),t.d(n,"serializeEvaluation",(function(){return cr})),t.d(n,"parseUnit",(function(){return J})),t.d(n,"serializeUnit",(function(){return H})),t.d(n,"parsePublicodes",(function(){return ir})),t.d(n,"utils",(function(){return r})),t.d(n,"Rule",(function(){})),t.d(n,"RuleNode",(function(){})),t.d(n,"ASTNode",(function(){return U.ASTNode})),t.d(n,"EvaluatedNode",(function(){return U.EvaluatedNode})),t.d(n,"default",(function(){return br})),t.d(n,"UNSAFE_isNotApplicable",(function(){return vr}));var r={};t.r(r),t.d(r,"nameLeaf",(function(){return Jn})),t.d(r,"encodeRuleName",(function(){return Zn})),t.d(r,"decodeRuleName",(function(){return Hn})),t.d(r,"ruleParents",(function(){return Gn})),t.d(r,"disambiguateRuleReference",(function(){return Yn})),t.d(r,"ruleWithDedicatedDocumentationPage",(function(){return Qn}));class a extends Error{}function i(e,n,t){throw new a('\n[ Erreur syntaxique ]\n➡️  Dans la règle "'.concat(e,'"\n✖️  ').concat(n,"\n    ").concat(t?t.message:"","\n"))}function o(e,n,t,r){e.warn('\n[ Avertissement ]\n➡️  Dans la règle "'.concat(n,'"\n⚠️  ').concat(t,"\n").concat(r?"ℹ️  ".concat(r.message):"","\n"))}class u extends a{constructor(e){super("\nErreur interne du moteur.\n\nCette erreur est le signe d'un bug dans publicodes. Pour nous aider à le résoudre, vous pouvez copier ce texte dans un nouveau ticket : https://github.com/betagouv/mon-entreprise/issues/new.\n\npayload:\n\t".concat(JSON.stringify(e,null,2),"\n"))}}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){c(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function c(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function p(e){return function n(t){var r=e(t,n);return!1===r?t:void 0===r?f(n,t):r}}function d(e,n,t){return function t(r,a){var i=e(r,a,t.bind(null,n));return void 0===i?function(e){var n=[];return f(e=>(n.push(e),e),e),n}(a).reduce(t,r):i}(n,t)}function m(e,n){return Object.fromEntries(Object.entries(n).map(n=>{var[t,r]=n;return[t,e(r)]}))}var f=(e,n)=>{switch(n.nodeKind){case"rule":return b(e,n);case"reference":case"constant":return O(e,n);case"applicable si":case"non applicable si":return y(e,n);case"arrondi":return D(e,n);case"barème":case"taux progressif":case"grille":return h(e,n);case"somme":case"une de ces conditions":case"une possibilité":case"toutes ces conditions":case"minimum":case"maximum":return j(e,n);case"durée":return P(e,n);case"inversion":return w(e,n);case"operation":return x(e,n);case"par défaut":return V(e,n);case"plancher":return S(e,n);case"plafond":return N(e,n);case"produit":return E(e,n);case"recalcul":return q(e,n);case"abattement":return k(e,n);case"nom dans la situation":return $(e,n);case"synchronisation":return A(e,n);case"unité":return K(e,n);case"variations":return R(e,n);case"variable temporelle":return T(e,n);case"replacementRule":return v(e,n);default:throw new u(n)}},b=(e,n)=>s(s({},n),{},{replacements:n.replacements.map(e),suggestions:Object.fromEntries(Object.entries(n.suggestions).map(n=>{var[t,r]=n;return[t,e(r)]})),explanation:{parent:n.explanation.parent&&e(n.explanation.parent),valeur:e(n.explanation.valeur)}}),v=(e,n)=>s(s({},n),{},{definitionRule:e(n.definitionRule),replacedReference:e(n.replacedReference),replacementNode:e(n.replacementNode),whiteListedNames:n.whiteListedNames.map(e),blackListedNames:n.blackListedNames.map(e)}),O=(e,n)=>n,y=(e,n)=>s(s({},n),{},{explanation:{condition:e(n.explanation.condition),valeur:e(n.explanation.valeur)}});function g(e,n){return n.map(n=>s(s(s(s({},n),n.plafond&&{plafond:e(n.plafond)}),"montant"in n&&{montant:e(n.montant)}),"taux"in n&&{taux:e(n.taux)}))}var h=(e,n)=>s(s({},n),{},{explanation:{assiette:e(n.explanation.assiette),multiplicateur:e(n.explanation.multiplicateur),tranches:g(e,n.explanation.tranches)}}),j=(e,n)=>s(s({},n),{},{explanation:n.explanation.map(e)}),x=(e,n)=>s(s({},n),{},{explanation:[e(n.explanation[0]),e(n.explanation[1])]}),P=(e,n)=>s(s({},n),{},{explanation:{depuis:e(n.explanation.depuis),"jusqu'à":e(n.explanation["jusqu'à"])}}),w=(e,n)=>s(s({},n),{},{explanation:s(s({},n.explanation),{},{inversionCandidates:n.explanation.inversionCandidates.map(e)})}),V=(e,n)=>s(s({},n),{},{explanation:{valeur:e(n.explanation.valeur),"parDéfaut":e(n.explanation.parDéfaut)}}),D=(e,n)=>s(s({},n),{},{explanation:{valeur:e(n.explanation.valeur),arrondi:e(n.explanation.arrondi)}}),S=(e,n)=>s(s({},n),{},{explanation:{valeur:e(n.explanation.valeur),plancher:e(n.explanation.plancher)}}),N=(e,n)=>s(s({},n),{},{explanation:{valeur:e(n.explanation.valeur),plafond:e(n.explanation.plafond)}}),E=(e,n)=>s(s({},n),{},{explanation:{assiette:e(n.explanation.assiette),taux:e(n.explanation.taux),facteur:e(n.explanation.facteur),plafond:e(n.explanation.plafond)}}),q=(e,n)=>s(s({},n),{},{explanation:{amendedSituation:n.explanation.amendedSituation.map(n=>{var[t,r]=n;return[e(t),e(r)]}),recalcul:e(n.explanation.recalcul)}}),k=(e,n)=>s(s({},n),{},{explanation:{assiette:e(n.explanation.assiette),abattement:e(n.explanation.abattement)}}),$=(e,n)=>s(s({},n),{},{explanation:s(s(s({},n.explanation),n.explanation.situationValeur&&{situationValeur:e(n.explanation.situationValeur)}),{},{valeur:e(n.explanation.valeur)})}),A=(e,n)=>s(s({},n),{},{explanation:s(s({},n.explanation),{},{data:e(n.explanation.data)})}),K=(e,n)=>s(s({},n),{},{explanation:e(n.explanation)}),R=(e,n)=>s(s({},n),{},{explanation:n.explanation.map(n=>{var{condition:t,consequence:r}=n;return{condition:e(t),consequence:e(r)}})}),T=(e,n)=>s(s({},n),{},{explanation:{period:{end:n.explanation.period.end&&e(n.explanation.period.end),start:n.explanation.period.start&&e(n.explanation.period.start)},value:e(n.explanation.value)}}),U=t(2),L={constant:e=>e};function M(e,n){var t;if(null!==(t=L)&&void 0!==t||(L={}),L[e])throw Error("Multiple evaluation functions registered for the nodeKind [4m".concat(e));L[e]=n}var C=t(3),I=t(5),_=t.n(I),F=t(0);function z(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function W(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?z(Object(t),!0).forEach((function(n){B(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):z(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function B(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}var J=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e=>e,[t,...r]=e.split("/").map(e=>e.trim()),a={numerators:t.split(".").filter(Boolean).map(e=>n(e)),denominators:r.map(e=>n(e))};return a},Z=function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e=>e;return e.sort().map(e=>t(e,n)).join(".")},H=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e=>e;if(null===e||"object"!=typeof e)return"string"==typeof e?t(e,n):e;var r=ee(e),{numerators:a=[],denominators:i=[]}=r,o=a.length>0,u=i.length>0,l=o||u?o&&!u?Z(a,n,t):!o&&u?"/".concat(Z(i,1,t)):"".concat(Z(a,2,t)," / ").concat(Z(i,1,t)):"";return l},G={numerators:[],denominators:[]},Y=(e,n)=>{if("/"===e){if(2!==n.length)throw new Error("Infer units of a division with units.length !== 2)");return Y("*",[n[0]||G,{numerators:(n[1]||G).denominators,denominators:(n[1]||G).numerators}])}var t=n.filter(Boolean);return t.length<=1?t[0]:"*"===e?ee({numerators:t.flatMap(e=>{var n;return null!==(n=null==e?void 0:e.numerators)&&void 0!==n?n:[]}),denominators:t.flatMap(e=>{var n;return null!==(n=null==e?void 0:e.denominators)&&void 0!==n?n:[]})}):"-"===e||"+"===e?n.find(e=>e):void 0},Q=(e,n)=>Array.isArray(e)&&Array.isArray(n)?e.length===n.length&&e.every((t,r)=>e[r]===n[r]):e===n,X=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Q;return t=>{var r=t.findIndex(t=>n(t,e));return t.filter((e,n)=>n!==r)}},ee=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Q;return[...e.numerators,...e.denominators].reduce((e,t)=>{var{numerators:r,denominators:a}=e;return r.find(e=>n(t,e))&&a.find(e=>n(t,e))?{numerators:X(t,n)(r),denominators:X(t,n)(a)}:{numerators:r,denominators:a}},e)},ne={"mois/an":12,"jour/an":365,"jour/mois":365/12,"trimestre/an":4,"mois/trimestre":3,"jour/trimestre":91.25,"€/k€":1e3,"g/kg":1e3,"mg/g":1e3,"mg/kg":10**6};function te(e,n){return ne["".concat(n,"/").concat(e)]||ne["".concat(e,"/").concat(n)]&&1/ne["".concat(e,"/").concat(n)]}function re(e,n){var t=100**(n.filter(e=>"%"===e).length-e.filter(e=>"%"===e).length);return[t]=e.reduce((e,n)=>{var[t,r]=e,a=r.findIndex(e=>!!te(n,e));return[t*(te(n,r[a])||1),[...r.slice(0,a+1),...r.slice(a+1)]]},[t,n]),t}function ae(e,n,t){if(!ce(e,n))throw new Error("Impossible de convertir l'unité '".concat(H(e),"' en '").concat(H(n),"'"));if(!t)return t;if(void 0===e)return t;var[r,a]=le(e||G),[i,o]=le(n||G);return ue(t*a/o*re(r.numerators,i.numerators)*re(i.denominators,r.denominators))}var ie=function(e){return Object.keys(e).reduce((e,n)=>{var[t,r]=n.split("/"),a=e.findIndex(e=>e.has(t)),i=e.findIndex(e=>e.has(r));if(a>-1&&i>-1&&a!==i)throw Error("Invalid ratio ".concat(n));return-1===a&&-1===i?e.push(new Set([t,r])):a>-1?e[a].add(r):i>-1&&e[i].add(t),e},[])}(ne);function oe(e,n){return e===n||ie.some(t=>t.has(e)&&t.has(n))}function ue(e){return+e.toFixed(16)}function le(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,t=re(e.numerators,e.denominators);return[ee(se(e),oe),n?ue(n*t):n]}var se=e=>({numerators:e.numerators.filter(e=>"%"!==e),denominators:e.denominators.filter(e=>"%"!==e)});function ce(e,n){if(null==e||null==n)return!0;var t,[r,a,i,o]=[e.numerators,e.denominators,n.numerators,n.denominators].map(e=>e.reduce((e,n)=>{var t,r=ie.findIndex(e=>e.has(n)),a=-1===r?n:""+r;return W(W({},e),{},{[a]:1+(null!==(t=e[a])&&void 0!==t?t:0)})},{})),u=[r,a,i,o].map(Object.keys).flat();return(t=u,[...new Set(t)]).every(e=>(r[e]||0)-(a[e]||0)==(i[e]||0)-(o[e]||0)||"%"===e)}function pe(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function de(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?pe(Object(t),!0).forEach((function(n){me(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):pe(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function me(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function fe(e){return e.unit?be(function(e){var{numerators:n,denominators:t}=ee(e,oe);return n.length&&n.every(e=>"%"===e)?{numerators:["%"],denominators:t}:se({numerators:n,denominators:t})}(e.unit),e):e}function be(e,n){var t=n.temporalValue&&n.unit?Object(F.e)(t=>ae(n.unit,e,t),n.temporalValue):n.temporalValue;return de(de(de({},n),{},{nodeValue:n.unit&&"number"==typeof n.nodeValue?ae(n.unit,e,n.nodeValue):n.nodeValue},t&&{temporalValue:t}),{},{unit:e})}function ve(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function Oe(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?ve(Object(t),!0).forEach((function(n){ye(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ve(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function ye(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}var ge=e=>"missingVariables"in e?e.missingVariables:{},he=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.fromEntries(Object.entries(e).map(e=>{var[n,t]=e;return[n,t+1e-4]}))},je=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object.fromEntries([...Object.keys(e),...Object.keys(n)].map(t=>{var r,a;return[t,(null!==(r=e[t])&&void 0!==r?r:0)+(null!==(a=n[t])&&void 0!==a?a:0)]}))},xe=e=>e.map(ge).reduce(je,{});function Pe(e,n){var t=e.find(e=>!!e.unit);return t?e.map(e=>{try{return be(t.unit,e)}catch(n){return o(this.options.logger,this.cache._meta.ruleStack[0],"Les unités des éléments suivants sont incompatibles entre elles : \n\t\t".concat((null==e?void 0:e.name)||(null==e?void 0:e.rawNode),"\n\t\t").concat((null==t?void 0:t.name)||(null==t?void 0:t.rawNode),"'"),n),e}}):e}var we=(e,n)=>function(t){var r=this.evaluate.bind(this),a=Pe.call(this,t.explanation.map(r),t.name),i=Object(F.a)(a.map(e=>{var{temporalValue:n,nodeValue:t}=e;return null!=n?n:Object(F.h)(t)})),o=Object(F.e)(t=>t.some(e=>null===e)?null:t.reduce(e,n),i),u=Oe(Oe({},t),{},{missingVariables:xe(a),explanation:a},a[0]&&{unit:a[0].unit});return 1===o.length?Oe(Oe({},u),{},{nodeValue:o[0].value}):Oe(Oe({},u),{},{temporalValue:o,nodeValue:Object(F.j)(o)})},Ve=e=>({nodeValue:e,type:typeof e,isDefault:!0,nodeKind:"constant"}),De=(e,n,t)=>Object.fromEntries(Object.entries(e).map(e=>{var[r,a]=e;if(null==n[r]&&!a)throw new Error("Il manque une clé '".concat(r,"' dans ").concat(JSON.stringify(n)," "));return[r,null!=n[r]?Zt(n[r],t):a]}));function Se(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function Ne(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?Se(Object(t),!0).forEach((function(n){Ee(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Se(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function Ee(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function qe(e,n){return{explanation:{assiette:Zt(e.valeur,n),abattement:Zt(e.abattement,n)},nodeKind:qe.nom}}function ke(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function $e(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?ke(Object(t),!0).forEach((function(n){Ae(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ke(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function Ae(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}qe.nom="abattement",M(qe.nom,(function(e){var n=this.evaluate(e.explanation.assiette),t=this.evaluate(e.explanation.abattement),r="%"===H(t.unit);if(n.unit&&!r)try{t=be(n.unit,t)}catch(e){o(this.options.logger,this.cache._meta.ruleStack[0],"Impossible de convertir les unités de l'allègement entre elles",e)}var a=n.nodeValue,i=t.nodeValue,u=t?null==a?null:null==i?0==a?0:null:"%"===H(t.unit)?Math.max(0,a-i/100*a):Math.max(0,a-i):a;return Ne(Ne({},e),{},{nodeValue:u,unit:n.unit,missingVariables:xe([n,t]),explanation:{assiette:n,abattement:t}})}));function Ke(e,n){return{explanation:{valeur:Zt(e.valeur,n),condition:Zt(e[Ke.nom],n)},nodeKind:Ke.nom}}function Re(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function Te(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?Re(Object(t),!0).forEach((function(n){Ue(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Re(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function Ue(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function Le(e,n){return+e.toFixed(n)}Ke.nom="applicable si",M(Ke.nom,(function(e){var n=$e({},e.explanation),t=this.evaluate(n.condition),r=n.valeur;return!1!==t.nodeValue&&(r=this.evaluate(r)),$e($e({},e),{},{nodeValue:null==t.nodeValue||!1===t.nodeValue?t.nodeValue:"nodeValue"in r?r.nodeValue:null,explanation:{valeur:r,condition:t},missingVariables:je("missingVariables"in r?r.missingVariables:{},he(t.missingVariables))},"unit"in r&&{unit:r.unit})}));function Me(e,n){return{explanation:{valeur:Zt(e.valeur,n),arrondi:Zt(e.arrondi,n)},nodeKind:Me.nom}}function Ce(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function Ie(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?Ce(Object(t),!0).forEach((function(n){_e(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Ce(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function _e(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}Me.nom="arrondi",M(Me.nom,(function(e){var n=fe(this.evaluate(e.explanation.valeur)),t=n.nodeValue,r=e.explanation.arrondi;return!1!==t&&(r=this.evaluate(r)),Te(Te({},e),{},{nodeValue:"number"==typeof n.nodeValue&&"nodeValue"in r?"number"==typeof r.nodeValue?Le(n.nodeValue,r.nodeValue):!0===r.nodeValue?Le(n.nodeValue,0):null===r.nodeValue?null:n.nodeValue:n.nodeValue,explanation:{valeur:n,arrondi:r},missingVariables:xe([n,r]),unit:n.unit})}));var Fe=(e,n)=>e.map((n,t)=>{var r;if(!n.plafond&&t>e.length)throw new SyntaxError("La tranche n°".concat(t," du barème n'a pas de plafond précisé. Seule la dernière tranche peut ne pas être plafonnée"));return Ie(Ie({},n),{},{plafond:null!==(r=n.plafond)&&void 0!==r?r:1/0})}).map(e=>Ie(Ie(Ie(Ie({},e),void 0!==e.taux?{taux:Zt(e.taux,n)}:{}),void 0!==e.montant?{montant:Zt(e.montant,n)}:{}),{},{plafond:Zt(e.plafond,n)}));function ze(e){var{multiplicateur:n,assiette:t,parsedTranches:r}=e;return r.reduce((e,r,a)=>{var[i,u]=e;if(u)return[[...i,Ie(Ie({},r),{},{isAfterActive:!0})],u];var l=this.evaluate(r.plafond),s=i[a-1]?i[a-1].plafond:{nodeValue:0},c=null===l.nodeValue||null===n.nodeValue?null:l.nodeValue*n.nodeValue;try{c=c===1/0||0===c?c:ae(Y("*",[l.unit,n.unit]),t.unit,c)}catch(e){o(this.options.logger,this.cache._meta.ruleStack[0],"L'unité du plafond de la tranche n°".concat(a+1,"  n'est pas compatible avec celle l'assiette"),e)}var p,d,m,f,b=i[a-1]?i[a-1].plafondValue:0,v=null===b||null===t.nodeValue?null:b>t.nodeValue,O=[l,t,n,s];if(O.some(e=>null===e.nodeValue))return[[...i,Ie(Ie({},r),{},{plafond:l,plafondValue:c,plancherValue:b,nodeValue:null,isActive:null,isAfterActive:v,missingVariables:xe(O)})],!1];i[a-1]&&b&&c<=b&&(p=this.options.logger,d=this.cache._meta.ruleStack[0],m="Le plafond de la tranche n°".concat(a+1," a une valeur inférieure à celui de la tranche précédente"),p.error("\n[ Erreur d'évaluation ]\n➡️  Dans la règle \"".concat(d,'"\n✖️  ').concat(m,"\n    ").concat(f?f.message:"","\n")));var y=Ie(Ie({},r),{},{plafond:l,plancherValue:b,plafondValue:c,isAfterActive:v,isActive:t.nodeValue>=b&&t.nodeValue<c});return[[...i,y],y.isActive]},[[],!1])[0]}function We(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function Be(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?We(Object(t),!0).forEach((function(n){Je(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):We(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function Je(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function Ze(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function He(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?Ze(Object(t),!0).forEach((function(n){Ge(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Ze(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function Ge(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function Ye(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}M("barème",(function(e){var n=this.evaluate.bind(this),t=this.evaluate(e.explanation.assiette),r=this.evaluate(e.explanation.multiplicateur),a=Object(F.c)((n,t)=>ze.call(this,{parsedTranches:e.explanation.tranches,assiette:n,multiplicateur:t}),Object(F.d)(t),Object(F.d)(r)),i=Object(F.c)((e,t)=>function(e,n,t,r){return e.map(e=>{if(e.isAfterActive)return Be(Be({},e),{},{nodeValue:0});var r=t(e.taux);return[n.nodeValue,r.nodeValue,e.plafondValue,e.plancherValue].some(e=>null===e)?Be(Be({},e),{},{taux:r,nodeValue:null,missingVariables:xe([r,e])}):Be(Be(Be({},e),{},{taux:r},"unit"in n&&{unit:n.unit}),{},{nodeValue:(Math.min(n.nodeValue,e.plafondValue)-e.plancherValue)*ae(r.unit,J(""),r.nodeValue),missingVariables:xe([r,e])})})}(e,t,n,this.cache),a,Object(F.d)(t)),o=Object(F.e)(e=>e.reduce((e,n)=>{var{nodeValue:t}=n;return null==t?null:e+t},0),i);return Be(Be(Be({},e),{},{nodeValue:Object(F.j)(o)},o.length>1?{temporalValue:o}:{missingVariables:xe(i[0].value)}),{},{explanation:Be({assiette:t,multiplicateur:r},i.length>1?{temporalTranches:i}:{tranches:i[0].value}),unit:t.unit})}));function Qe(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function Xe(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?Qe(Object(t),!0).forEach((function(n){en(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Qe(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function en(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function nn(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function tn(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?nn(Object(t),!0).forEach((function(n){rn(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):nn(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function rn(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}M("toutes ces conditions",(function(e){var[n,t]=e.explanation.reduce((e,n)=>{var[t,r]=e;if(!1===t)return[t,[...r,n]];var a=this.evaluate(n);return[null===t||null===a.nodeValue?null:!!a.nodeValue,[...r,a]]},[!0,[]]);return Xe(Xe({},e),{},{nodeValue:n,explanation:t,missingVariables:xe(t)})}));M("une de ces conditions",(function(e){var n=e.explanation.reduce((e,n)=>{if(!0===e.nodeValue)return tn(tn({},e),{},{explanation:[...e.explanation,n]});if(null===e.nodeValue||!1===e.nodeValue){var t=this.evaluate(n);return{nodeValue:!!t.nodeValue||(null===t.nodeValue?null:e.nodeValue),missingVariables:t.nodeValue?{}:je(e.missingVariables,t.missingVariables),explanation:[...e.explanation,t]}}throw new u([n,e])},{nodeValue:!1,missingVariables:{},explanation:[]});return tn(tn({},e),n)}));var an=t(1);function on(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function un(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?on(Object(t),!0).forEach((function(n){ln(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):on(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function ln(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}var sn=Object(an.b)(new Date),cn={depuis:Ve(sn),"jusqu'à":Ve(sn)};function pn(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function dn(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?pn(Object(t),!0).forEach((function(n){mn(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):pn(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function mn(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}M("durée",(function(e){var n,t=this.evaluate(e.explanation.depuis),r=this.evaluate(e.explanation["jusqu'à"]);if([t,r].some(e=>{var{nodeValue:n}=e;return null===n}))n=null;else{var[a,i]=[t.nodeValue,r.nodeValue].map(an.a);n=Math.max(0,Math.round((i.getTime()-a.getTime())/864e5))}var o=xe([t,r]);return un(un({},e),{},{missingVariables:o,nodeValue:n,explanation:{depuis:t,"jusqu'à":r}})}));function fn(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function bn(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?fn(Object(t),!0).forEach((function(n){vn(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):fn(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function vn(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}M("grille",(function(e){var n,t,r=this.evaluate.bind(this),a=this.evaluate(e.explanation.assiette),i=this.evaluate(e.explanation.multiplicateur),o=Object(F.c)((n,t)=>ze.call(this,{parsedTranches:e.explanation.tranches,assiette:n,multiplicateur:t}),Object(F.d)(a),Object(F.d)(i)),u=Object(F.e)(e=>((e,n)=>e.map(e=>{if(!1===e.isActive)return e;var t=n(e.montant);return dn(dn({},e),{},{montant:t,nodeValue:t.nodeValue,unit:t.unit,missingVariables:xe([t,e])})}))(e,r),o),l=Object(F.e)(e=>{var n=e.find(e=>e.isActive);return n?[n]:!1===e[e.length-1].isAfterActive?[{nodeValue:!1}]:e.filter(e=>null===e.isActive)},u),s=Object(F.e)(e=>null===e[0].isActive?null:e[0].nodeValue,l);return dn(dn(dn({},e),{},{nodeValue:Object(F.j)(s)},s.length>1?{temporalValue:s}:{missingVariables:xe(l[0].value)}),{},{explanation:dn(dn({},e.explanation),{},{assiette:a,multiplicateur:i},u.length>1?{temporalTranches:u}:{tranches:u[0].value}),unit:null!==(n=null===(t=l[0].value[0])||void 0===t?void 0:t.unit)&&void 0!==n?n:void 0})}));M("inversion",(function(e){var n=e.explanation.inversionCandidates.find(e=>null!=this.parsedSituation[e.dottedName]);if(void 0===n){var t=bn(bn({},Object.fromEntries(e.explanation.inversionCandidates.map(e=>[e.dottedName,1]))),{},{[e.explanation.ruleToInverse]:1});return bn(bn({},e),{},{missingVariables:t,nodeValue:null})}var r=this.evaluate(n),a="unit"in e?e.unit:r.unit,i=this.cache,o=bn({},this.parsedSituation),u=0;delete this.parsedSituation[n.dottedName];var l=t=>(u++,this.resetCache(),this.cache._meta=bn({},i._meta),this.parsedSituation[e.explanation.ruleToInverse]={unit:a,nodeKind:"unité",explanation:{nodeKind:"constant",nodeValue:t,type:"number"}},be(a,this.evaluate(n))),s=be(a,r).nodeValue,c=null,p=s,d=l(p),m=d.nodeValue,f=null!==m?p*s*(m>s?.9:1.2)/m:2e3,b=l(f),v=b.nodeValue,O=je(d.missingVariables,b.missingVariables);if(null!==m||null!==v){c=function(e,n,t){for(var r,a,i,o,u,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:100,c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,p=n,d=t,m=p,f=e(p),b=e(d),v=f,O=void 0;s-- >0;){if(i=d-p,Math.abs(v)<Math.abs(b)&&(p=d,d=m,m=p,f=b,b=v,v=f),r=1e-15*Math.abs(d)+l/2,a=(m-d)/2,Math.abs(a)<=r||0===b)return d;if(Math.abs(i)>=r&&Math.abs(f)>Math.abs(b)){var y=void 0,g=void 0,h=m-d;p===m?(o=h*(y=b/f),u=1-y):(o=(g=b/f)*(h*(u=f/v)*(u-(y=b/v))-(d-p)*(y-1)),u=(u-1)*(y-1)*(g-1)),o>0?u=-u:o=-o,o<.75*h*u-Math.abs(r*u)/2&&o<Math.abs(i*u/2)&&(a=o/u)}Math.abs(a)<r&&(a=a>0?r:-r),p=d,f=b,((b=e(d+=a))>0&&v>0||b<0&&v<0)&&(m=p,v=f),Math.abs(b)<c&&(O=d)}return O}(e=>(e===p?m:e===f?v:l(e).nodeValue)-s,null!==v&&v<s&&(v>m||m>s)?f:null!==m&&m<s&&(m>v||v>s)?p:-1e6,null!==v&&v>s&&(v<m||m<s)?f:null!==m&&m>s&&(m<v||v<s)?p:1e8,.1,10,1)}return void 0===c&&(c=null,i._meta.inversionFail=!0),this.cache=i,this.parsedSituation=o,bn(bn({},e),{},{unit:a,nodeValue:c,explanation:bn(bn({},e.explanation),{},{inversionGoal:n,inversionNumberOfIterations:u}),missingVariables:O})}));M("maximum",we((e,n)=>!1===e?n:!1===n?e:null===e||null===n?null:Math.max(e,n),!1));function On(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function yn(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?On(Object(t),!0).forEach((function(n){gn(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):On(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function gn(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}M("minimum",we((e,n)=>Math.min(e,n),1/0));function hn(e,n){return{explanation:{valeur:Zt(e.valeur,n),condition:Zt(e[hn.nom],n)},nodeKind:hn.nom}}function jn(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function xn(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?jn(Object(t),!0).forEach((function(n){Pn(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):jn(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function Pn(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}hn.nom="non applicable si",M(hn.nom,(function(e){var n=this.evaluate(e.explanation.condition),t=e.explanation.valeur;return!1!==n.nodeValue&&null!==n.nodeValue||(t=this.evaluate(t)),yn(yn({},e),{},{nodeValue:null===n.nodeValue?null:!1===n.nodeValue&&("nodeValue"in t?t.nodeValue:null),explanation:{valeur:t,condition:n},missingVariables:je("missingVariables"in t?t.missingVariables:{},he(n.missingVariables))},"unit"in t&&{unit:t.unit})}));function wn(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function Vn(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?wn(Object(t),!0).forEach((function(n){Dn(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):wn(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function Dn(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}M("une possibilité",e=>xn(xn({},e),{},{nodeValue:null,missingVariables:{[e.context]:1}}));var Sn={"*":[(e,n)=>e*n,"×"],"/":[(e,n)=>e/n,"∕"],"+":[(e,n)=>e+n],"-":[(e,n)=>e-n,"−"],"<":[(e,n)=>e<n],"<=":[(e,n)=>e<=n,"≤"],">":[(e,n)=>e>n],">=":[(e,n)=>e>=n,"≥"],"=":[(e,n)=>e===n],"!=":[(e,n)=>e!==n,"≠"]},Nn=(e,n)=>(t,r)=>{var a=t.explanation.map(e=>Zt(e,r));return Vn(Vn({},t),{},{nodeKind:"operation",operationKind:e,operator:n||e,explanation:a})};M("operation",(function(e){var n,t,r=e.explanation.map(e=>this.evaluate(e)),[a,i]=r,u=xe([a,i]);if(null==a.nodeValue||null==i.nodeValue)return Vn(Vn({},e),{},{nodeValue:null,explanation:r,missingVariables:u});if(!["∕","×"].includes(e.operator))try{a.unit&&"unit"in i?i=be(a.unit,i):i.unit&&(a=be(i.unit,a))}catch(n){o(this.options.logger,"Dans l'expression '".concat(e.operator,"', la partie gauche (unité: ").concat(H(a.unit),") n'est pas compatible avec la partie droite (unité: ").concat(H(i.unit),")"),n)}var l=Vn(Vn(Vn({},e),{},{explanation:r},("*"===e.operationKind||"/"===e.operationKind||"-"===e.operationKind||"+"===e.operationKind)&&{unit:Y(e.operationKind,[a.unit,i.unit])}),{},{missingVariables:u}),s=Sn[e.operationKind][0],c=Object(F.c)((n,t)=>!(!["≠","="].includes(e.operator)&&!1===n&&!1===t)&&((!["<",">","≤","≥","∕","×"].includes(e.operator)||!1!==n&&!1!==t)&&(!1!==n&&!1!==t&&["≠","=","<",">","≤","≥"].includes(e.operator)&&[n,t].every(e=>{var n;return null===(n=e.match)||void 0===n?void 0:n.call(e,/[\d]{2}\/[\d]{2}\/[\d]{4}/)})?s(Object(an.a)(n),Object(an.a)(t)):s(n,t))),null!==(n=a.temporalValue)&&void 0!==n?n:Object(F.h)(a.nodeValue),null!==(t=i.temporalValue)&&void 0!==t?t:Object(F.h)(i.nodeValue)),p=Object(F.j)(c,l.unit);return Vn(Vn({},l),{},{nodeValue:p},c.length>1&&{temporalValue:c})}));var En=Object.fromEntries(Object.entries(Sn).map(e=>{var[n,[t,r]]=e;return[n,Nn(n,r)]}));function qn(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function kn(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?qn(Object(t),!0).forEach((function(n){$n(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):qn(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function $n(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function An(e,n){return{explanation:{valeur:Zt(e.valeur,n),"parDéfaut":Zt(e["par défaut"],n)},nodeKind:An.nom}}function Kn(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function Rn(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?Kn(Object(t),!0).forEach((function(n){Tn(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Kn(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function Tn(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}An.nom="par défaut",M(An.nom,(function(e){var n=kn({},e.explanation),t=this.evaluate(n.valeur);return n.valeur=t,null===t.nodeValue&&(t=this.evaluate(n.parDéfaut),n.parDéfaut=t),kn(kn({},e),{},{nodeValue:t.nodeValue,explanation:n,missingVariables:je(he(n.valeur.missingVariables),"missingVariables"in n.parDéfaut?n.parDéfaut.missingVariables:{})},"unit"in t&&{unit:t.unit})}));function Un(e,n){return{explanation:{valeur:Zt(e.valeur,n),plafond:Zt(e.plafond,n)},nodeKind:"plafond"}}function Ln(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function Mn(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?Ln(Object(t),!0).forEach((function(n){Cn(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Ln(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function Cn(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}Un.nom="plafond",M("plafond",(function(e){var n=this.evaluate(e.explanation.valeur),t=n.nodeValue,r=e.explanation.plafond;if(!1!==t){var a=this.evaluate(r);if(n.unit)try{r=be(n.unit,a)}catch(e){o(this.options.logger,this.cache._meta.ruleStack[0],"L'unité du plafond n'est pas compatible avec celle de la valeur à encadrer",e)}}return"number"==typeof t&&"nodeValue"in r&&"number"==typeof r.nodeValue&&t>r.nodeValue&&(t=r.nodeValue,r.isActive=!0),Rn(Rn(Rn({},e),{},{nodeValue:t},"unit"in n&&{unit:n.unit}),{},{explanation:{valeur:n,plafond:r},missingVariables:xe([n,r])})}));function In(e,n){return{explanation:{valeur:Zt(e.valeur,n),plancher:Zt(e.plancher,n)},nodeKind:"plancher"}}In.nom="plancher",M("plancher",(function(e){var n=this.evaluate(e.explanation.valeur),t=n.nodeValue,r=e.explanation.plancher;if(!1!==t){var a=this.evaluate(r);if(n.unit)try{r=be(n.unit,a)}catch(e){o(this.options.logger,this.cache._meta.ruleStack[0],"L'unité du plancher n'est pas compatible avec celle de la valeur à encadrer",e)}}return"number"==typeof t&&"nodeValue"in r&&"number"==typeof r.nodeValue&&t<r.nodeValue&&(t=r.nodeValue,r.isActive=!0),Mn(Mn(Mn({},e),{},{nodeValue:t},"unit"in n&&{unit:n.unit}),{},{explanation:{valeur:n,plancher:r},missingVariables:xe([n,r])})}));var _n,Fn={assiette:!1,taux:Ve(1),facteur:Ve(1),plafond:Ve(1/0)},zn=(e,n)=>({explanation:De(Fn,e,n),nodeKind:"produit"});M("produit",(_n=function(e){var{assiette:n,taux:t,facteur:r,plafond:a}=e;if(n.unit)try{a=be(n.unit,a)}catch(e){o(this.options.logger,this.cache._meta.ruleStack[0],"Impossible de convertir l'unité du plafond du produit dans celle de l'assiette",e)}var i=![t,n,r].some(e=>!1===e.nodeValue)&&([t,n,r].some(e=>0===e.nodeValue)?0:[t,n,r].some(e=>null===e.nodeValue)?null:((e,n,t,r)=>Math.min(e,!1===r?1/0:r)*n*t)(n.nodeValue,t.nodeValue,r.nodeValue,a.nodeValue)),u=Y("*",[n,t,r].map(e=>e.unit));return ce(u,n.unit)&&(i=ae(u,n.unit,i),u=n.unit),fe({nodeValue:i,unit:u,explanation:{plafondActif:n.nodeValue>a.nodeValue}})},function(e){var n=Object.fromEntries(Object.entries(e.explanation).map(e=>{var[n,t]=e;return[n,this.evaluate(t)]})),t=Object(F.e)(Object.fromEntries,Object(F.a)(Object.entries(n).map(e=>{var[n,t]=e;return Object(F.k)(Object(F.h)(n),Object(F.d)(t))}))),r=Object(F.e)(e=>{var n=_n.call(this,e);return Oe(Oe({},n),{},{explanation:Oe(Oe({},e),n.explanation)})},t),a=Pe.call(this,r.map(e=>e.value),e.nodeKind).map((e,n)=>Oe(Oe({},r[n]),{},{value:fe(e)})),i=Object(F.e)(e=>{var{nodeValue:n}=e;return n},a),o=Object(F.j)(i),u=Oe(Oe({},e),{},{nodeValue:o,unit:a[0].value.unit,explanation:n,missingVariables:xe(Object.values(n))});return 1===a.length?Oe(Oe({},u),{},{explanation:a[0].value.explanation}):Oe(Oe({},u),{},{temporalValue:i,temporalExplanation:r})}));var Wn=e=>e.split(" . "),Bn=e=>e.join(" . "),Jn=e=>{var n;return null===(n=Wn(e).slice(-1))||void 0===n?void 0:n[0]},Zn=e=>null==e?void 0:e.replace(/\s\.\s/g,"/").replace(/-/g,"‑").replace(/\s/g,"-"),Hn=e=>e.replace(/\//g," . ").replace(/-/g," ").replace(/\u2011/g,"-");function Gn(e){var n=Wn(e);return Array(n.length-1).fill(0).map((e,t)=>n.slice(0,t+1)).map(Bn).reverse()}function Yn(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",t=arguments.length>2?arguments[2]:void 0,r=[n,...Gn(n),""].map(e=>e?e+" . "+t:t).sort((e,t)=>e===n?1:t===n?-1:0),a=r.find(n=>n in e);if(!a)throw i(n,"La référence '".concat(t,"' est introuvable.\n\tVérifiez que l'orthographe et l'espace de nom sont corrects")),new Error;return a}function Qn(e){return!0!==e.virtualRule&&"groupe"!==e.type&&"texte"!==e.type&&"paragraphe"!==e.type&&"notification"!==e.type}function Xn(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function et(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?Xn(Object(t),!0).forEach((function(n){nt(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Xn(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function nt(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function tt(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function rt(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?tt(Object(t),!0).forEach((function(n){at(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):tt(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function at(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function it(e,n){var t={situationKey:e[it.nom],valeur:Zt(e.valeur,n)};return{nodeKind:it.nom,explanation:t}}M("recalcul",(function(e){if(this.cache._meta.inRecalcul)return Ve(!1);var n=e.explanation.amendedSituation.map(e=>{var[n,t]=e;return[this.evaluate(n),this.evaluate(t)]}).filter(e=>{var[n,t]=e;return n.nodeValue!==t.nodeValue||H(n.unit)!==H(t.unit)}),t=this.cache,r=et({},this.parsedSituation),a=Object.keys(n).length>0;a&&(this.resetCache(),this.cache._meta=et(et({},this.cache._meta),{},{inRecalcul:!0})),this.parsedSituation=et(et({},this.parsedSituation),Object.fromEntries(n.map(e=>{var[n,t]=e;return[Yn(this.parsedRules,n.contextDottedName,n.name),t]})));var i=this.evaluate(e.explanation.recalcul);return this.parsedSituation=r,a&&(this.cache=t),et(et(et({},e),{},{nodeValue:i.nodeValue,explanation:{recalcul:i,amendedSituation:n},missingVariables:i.missingVariables},"unit"in i&&{unit:i.unit}),i.temporalValue&&{temporalValue:i.temporalValue})})),it.nom="nom dans la situation",M(it.nom,(function(e){var n,t,r=rt({},e.explanation),a=r.situationKey;a in this.parsedSituation?(t=this.evaluate(this.parsedSituation[a]),r.situationValeur=t):(t=this.evaluate(r.valeur),r.valeur=t,delete r.situationValeur);var i=null!==(n=t.unit)&&void 0!==n?n:"unit"in r.valeur?r.valeur.unit:void 0,o=xe([r.situationValeur,r.valeur].filter(Boolean));return rt(rt(rt({},e),{},{nodeValue:t.nodeValue,missingVariables:0===Object.keys(o).length&&null===t.nodeValue?{[a]:1}:o},void 0!==i&&{unit:i}),{},{explanation:r})}));function ot(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function ut(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?ot(Object(t),!0).forEach((function(n){lt(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ot(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function lt(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}M("somme",we((e,n)=>e+n,0));function st(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function ct(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?st(Object(t),!0).forEach((function(n){pt(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):st(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function pt(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}M("synchronisation",(function(e){var n=this.evaluate(e.explanation.data),t=e.explanation.chemin.split(" . "),r=e=>t.reduce((e,n)=>e[n],e),a=null==n.nodeValue?null:r(n.nodeValue),i=null==a&&null!=n.nodeValue?r(n.explanation.defaultValue):a,o=ut(ut({},n.missingVariables),null===n.nodeValue?{[n.dottedName]:1}:{}),u=ut(ut({},e.explanation),{},{data:n});return ut(ut({},e),{},{nodeValue:i,explanation:u,missingVariables:o})}));function dt(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function mt(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?dt(Object(t),!0).forEach((function(n){ft(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):dt(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function ft(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function bt(e,n){return{explanation:Zt(e.valeur,n),unit:J(e.unité,n.getUnitKey),nodeKind:bt.nom}}function vt(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function Ot(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?vt(Object(t),!0).forEach((function(n){yt(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):vt(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function yt(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}M("taux progressif",(function(e){var n=this.evaluate.bind(this),t=this.evaluate(e.explanation.assiette),r=this.evaluate(e.explanation.multiplicateur),a=ze.call(this,{parsedTranches:e.explanation.tranches,assiette:t,multiplicateur:r}),i=ct(ct({},e),{},{explanation:{tranches:a,assiette:t,multiplicateur:r},unit:J("%")}),o=a[a.length-1];if(a.every(e=>{var{isActive:n}=e;return!1===n})||o.isActive&&o.plafond.nodeValue===1/0){var u=be(J("%"),n(o.taux)),{nodeValue:l,missingVariables:s}=u;return o.taux=u,o.nodeValue=l,o.missingVariables=s,ct(ct({},i),{},{nodeValue:l,missingVariables:s})}if(a.every(e=>{var{isActive:n}=e;return!0!==n})||"number"!=typeof t.nodeValue)return ct(ct({},i),{},{nodeValue:null,missingVariables:xe(a)});var c=a.findIndex(e=>{var{isActive:n}=e;return!0===n}),p=a[c];p.taux=be(J("%"),n(p.taux));var d=a[c-1];d&&(d.taux=be(J("%"),n(d.taux)),d.isActive=!0);var m=d?d.taux:p.taux,f=[m,p.taux,p];if(f.some(e=>null===e.nodeValue))return p.nodeValue=null,p.missingVariables=xe(f),ct(ct({},i),{},{nodeValue:null,missingVariables:p.missingVariables});var b=m.nodeValue,v=p.taux.nodeValue,O=p.plancherValue,y=(v-b)/(p.plafondValue-O),g=b+(t.nodeValue-O)*y;return p.nodeValue=g,ct(ct({},i),{},{nodeValue:g,missingVariables:{}})})),bt.nom="unité",M(bt.nom,(function(e){var n=this.evaluate(e.explanation),t=n.nodeValue;if(!1!==t&&"unit"in e)try{t=ae(n.unit,e.unit,n.nodeValue)}catch(e){o(this.options.logger,this.cache._meta.ruleStack[0],"Erreur lors de la conversion d'unité explicite",e)}return mt(mt({},e),{},{nodeValue:t,explanation:n,missingVariables:n.missingVariables})}));function gt(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function ht(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?gt(Object(t),!0).forEach((function(n){jt(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):gt(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function jt(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function xt(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}M("variable temporelle",(function(e){var n=e.explanation.period.start&&this.evaluate(e.explanation.period.start),t=e.explanation.period.end&&this.evaluate(e.explanation.period.end),r=this.evaluate(e.explanation.value),a={start:(null==n?void 0:n.nodeValue)||null,end:(null==t?void 0:t.nodeValue)||null},i=r.temporalValue?Object(F.f)(a,r.temporalValue):Object(F.b)(r.nodeValue,a);return Ot(Ot({},e),{},{nodeValue:Object(F.j)(i,r.unit),temporalValue:i,explanation:{period:{start:n,end:t},value:r}},"unit"in r&&{unit:r.unit})}));function Pt(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function wt(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?Pt(Object(t),!0).forEach((function(n){Vt(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Pt(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function Vt(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function Dt(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function St(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?Dt(Object(t),!0).forEach((function(n){Nt(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Dt(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function Nt(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}M("variations",(function(e){var[n,t,r]=e.explanation.reduce((e,n,t)=>{var r,a,[i,u,l,s]=e,{condition:c,consequence:p}=n;if(!Object(F.i)(e=>!0!==e,s))return[i,[...u,{condition:c,consequence:p}],l,s];var d=this.evaluate(c),m=Object(F.c)((e,n)=>null===e?e:!e&&(null===n?null:!1!==n),s,null!==(r=d.temporalValue)&&void 0!==r?r:Object(F.h)(d.nodeValue));if(d.missingVariables=he(d.missingVariables),!Object(F.i)(e=>!1!==e,m))return[i,[...u,{condition:d,consequence:p}],l,s];var f=this.evaluate(p);if(l)try{f=be(l,f)}catch(e){o(this.options.logger,this.cache._meta.ruleStack[0],"L'unité de la branche n° ".concat(t+1," du mécanisme 'variations' n'est pas compatible avec celle d'une branche précédente"),e)}var b=Object(F.c)((e,n)=>e&&n,m,null!==(a=f.temporalValue)&&void 0!==a?a:Object(F.h)(f.nodeValue)),v=(e,n)=>e||n;return[Object(F.c)(v,i,b),[...u,{condition:d,satisfied:!!d.nodeValue,consequence:f}],l||f.unit,Object(F.c)(v,s,m)]},[Object(F.h)(!1),[],void 0,Object(F.h)(!1)]),a=Object(F.j)(n,r),i=xe(t.reduce((e,n)=>{var{condition:t,consequence:r}=n;return[...e,t,r]},[]));return ht(ht(ht({},e),{},{nodeValue:a},void 0!==r&&{unit:r}),{},{explanation:t,missingVariables:i},n.length>1&&{temporalValue:n})})),M("reference",(function(e){if(!e.dottedName)throw new u(e);var n=this.evaluate(this.parsedRules[e.dottedName]);return wt(wt({},e),{},{missingVariables:n.missingVariables,nodeValue:n.nodeValue},"unit"in n&&{unit:n.unit})}));var Et=0,qt={};function kt(e,n){return e?(Array.isArray(e)?e:[e]).map(e=>{var t,r,a;"string"==typeof e&&(e={"règle":e});var i=Zt(e.règle,n),o=Zt(null!==(t=e.par)&&void 0!==t?t:n.dottedName,n),[u,l]=[null!==(r=e.dans)&&void 0!==r?r:[],null!==(a=e["sauf dans"])&&void 0!==a?a:[]].map(e=>Array.isArray(e)?e:[e]).map(e=>e.map(e=>Zt(e,n)));return{nodeKind:"replacementRule",rawNode:e,definitionRule:Zt(n.dottedName,n),replacedReference:i,replacementNode:o,whiteListedNames:u,blackListedNames:l,remplacementRuleId:Et++}}):[]}function $t(e,n){return kt(e,n).map(e=>St(St({},e),{},{replacementNode:Ve(!1)}))}function At(e){return Object.values(e).flatMap(e=>e.replacements).reduce((e,n)=>{var t;if(!n.replacedReference.dottedName)throw new u(n);var r=n.replacedReference.dottedName;return St(St({},e),{},{[r]:[...null!==(t=e[r])&&void 0!==t?t:[],n]})},{})}function Kt(e,n){return p((n,t)=>{if("replacementRule"===n.nodeKind||"inversion"===n.nodeKind||"une possibilité"===n.nodeKind)return!1;if("recalcul"===n.nodeKind)return St(St({},n),{},{explanation:{recalcul:t(n.explanation.recalcul),amendedSituation:n.explanation.amendedSituation.map(e=>{var[n,r]=e;return[n,t(r)]})}});if("reference"===n.nodeKind){var r;if(!n.dottedName)throw new u(n);return function(e,n,t){var r,a=n.filter(n=>{var{definitionRule:t}=n;return t.dottedName!==e.contextDottedName}).filter(n=>{var{whiteListedNames:t}=n;return!t.length||t.some(n=>e.contextDottedName.startsWith(n.dottedName))}).filter(n=>{var{blackListedNames:t}=n;return!t.length||t.every(n=>!e.contextDottedName.startsWith(n.dottedName))}).sort((e,n)=>{var t=+!!n.whiteListedNames.length-+!!e.whiteListedNames.length,r=+!!n.blackListedNames.length-+!!e.blackListedNames.length;return t||r});if(!a.length)return e;if(a.length>1){!1}var i=a.map(e=>e.remplacementRuleId).join("-");return null!==(r=qt[i])&&void 0!==r||(qt[i]={nodeKind:"variations",visualisationKind:"replacement",rawNode:e.rawNode,explanation:[...a.map(e=>({condition:e.definitionRule,consequence:e.replacementNode})),{condition:Ve(!0),consequence:e}]}),qt[i]}(n,null!==(r=e[n.dottedName])&&void 0!==r?r:[])}})}var Rt=e=>{var{style:n,maximumFractionDigits:t=2,minimumFractionDigits:r=0,language:a}=e;return e=>{var i="currency"===n&&t>=2&&0===r&&!Number.isInteger(e)?2:r;return Intl.NumberFormat(a,{style:n,currency:"EUR",maximumFractionDigits:t,minimumFractionDigits:i}).format(e)}};function Tt(e){var{maximumFractionDigits:n,minimumFractionDigits:t,language:r,formatUnit:a,unit:i,value:o}=e;if("number"!=typeof o)return o;var u=i?H(i,o,a):void 0;switch(u){case"€":return Rt({style:"currency",maximumFractionDigits:n,minimumFractionDigits:t,language:r})(o);case"%":return Rt({style:"percent",maximumFractionDigits:n,language:r})(o/100);default:return Rt({style:"decimal",minimumFractionDigits:t,maximumFractionDigits:n,language:r})(o)+("string"==typeof u?" ".concat(u):"")}}function Ut(e){return e&&e[0].toUpperCase()+e.slice(1)}var Lt={fr:{true:"Oui",false:"Non"},en:{true:"Yes",false:"No"}};function Mt(e){var{language:n="fr",displayedUnit:t,formatUnit:r,precision:a=2}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i="number"==typeof e||void 0===e?e:e.nodeValue,o=null!=t?t:"number"!=typeof e&&void 0!==e&&"unit"in e?e.unit:void 0;return"number"==typeof i&&Number.isNaN(i)||null==i?"-":"string"==typeof i?Ut(i.replace("\\n","\n")):"object"==typeof i?i.nom:"boolean"==typeof i?Lt[n][i]:"number"==typeof i?Tt({minimumFractionDigits:0,maximumFractionDigits:a,language:n,formatUnit:r,unit:o,value:i}):null}function Ct(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function It(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?Ct(Object(t),!0).forEach((function(n){_t(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Ct(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function _t(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function Ft(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}function zt(e){var n=function(e,n){if("object"!=typeof e||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,n||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(e)}(e,"string");return"symbol"==typeof n?n:String(n)}function Wt(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function Bt(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?Wt(Object(t),!0).forEach((function(n){Jt(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Wt(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function Jt(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function Zt(e,n){null==e&&i(n.dottedName,"\nUne des valeurs de la formule est vide.\nVérifiez que tous les champs à droite des deux points sont remplis"),"boolean"==typeof e&&i(n.dottedName,"\nLes valeurs booléennes true / false ne sont acceptées.\nUtilisez leur contrepartie française : 'oui' / 'non'");var t="object"==typeof e?e:function(e,n){try{var[t]=new C.Parser(Ht).feed(e+"").results;return t}catch(t){i(n.dottedName,"`".concat(e,"` n'est pas une expression valide"),t)}}(e,n);return"nom"in t?function(e,n){var t,r,a=[n.dottedName,e.nom].filter(Boolean).join(" . "),i=Jn(a),o=Ut(null!==(t=e.titre)&&void 0!==t?t:n.ruleTitle?"".concat(n.ruleTitle," (").concat(i,")"):i);if(n.parsedRules[a])throw new Error("La référence '".concat(a,"' a déjà été définie"));var u=It(It(It({},Object.fromEntries(Object.entries(e).filter(e=>{var[n]=e;return Xt.includes(n)}))),"formule"in e&&{valeur:e.formule}),{},{"nom dans la situation":a}),l=It(It({},n),{},{dottedName:a,ruleTitle:o}),[s]=Gn(a),c={valeur:Zt(u,l),parent:!!s&&Zt(s,n)};return n.parsedRules[a]={dottedName:a,replacements:[...$t(e["rend non applicable"],l),...kt(e.remplace,l)],title:o,suggestions:Object.fromEntries(Object.entries(null!==(r=e.suggestions)&&void 0!==r?r:{}).map(e=>{var[n,t]=e;return[n,Zt(t,l)]})),nodeKind:"rule",explanation:c,rawNode:e,virtualRule:!!n.dottedName},Zt(e.nom,n)}(t,n):Bt(Bt({},function(e,n){var t=Yt.find(n=>n.nom in e);if(!t)return Gt(e,n);var r=t.nom,{[r]:a}=e,i=Ft(e,[r].map(zt));return Gt({[t.nom]:{valeur:i,[t.nom]:a}},n)}(t,n)),{},{rawNode:e})}M("rule",(function(e){var n,t;if(this.cache[e.dottedName])return this.cache[e.dottedName];var r=It({},e.explanation),a=!this.cache._meta.ruleStack.includes(e.dottedName);this.cache._meta.ruleStack.unshift(e.dottedName);var i=null;r.parent&&a&&(i=this.evaluate(r.parent),r.parent=i);var o=null;i&&!1===i.nodeValue||(o=this.evaluate(r.valeur),r.valeur=o);var u=It(It({},e),{},{explanation:r,nodeValue:!(!o||!("nodeValue"in o))&&o.nodeValue,missingVariables:je(null===(n=o)||void 0===n?void 0:n.missingVariables,he(null===(t=i)||void 0===t?void 0:t.missingVariables))},o&&"unit"in o&&{unit:o.unit});return this.cache._meta.ruleStack.shift(),this.cache[e.dottedName]=u,u}));var Ht=C.Grammar.fromCompiled(_.a);function Gt(e,n){Array.isArray(e)&&i(n.dottedName,"\nIl manque le nom du mécanisme pour le tableau : [".concat(e.map(e=>"'".concat(e,"'")).join(", "),"]\nLes mécanisme possibles sont : 'somme', 'le maximum de', 'le minimum de', 'toutes ces conditions', 'une de ces conditions'.\n\t\t"));var t=Object.keys(e);if(t.length>1&&i(n.dottedName,"\nLes mécanismes suivants se situent au même niveau : ".concat(t.map(e=>"'".concat(e,"'")).join(", "),"\nCela vient probablement d'une erreur dans l'indentation\n\t")),0===t.length)return{nodeKind:"constant",nodeValue:null};var r=Object.keys(e)[0],o=e[r],u=Qt[r];u||i(n.dottedName,"\nLe mécanisme ".concat(r," est inconnu.\nVérifiez qu'il n'y ait pas d'erreur dans l'orthographe du nom."));try{return(null==o?void 0:o.composantes)?((e,n,t)=>{var{composantes:r}=n,a=Ye(n,["composantes"]),i=Zt({somme:r.map(n=>{var{attributs:t}=n,r=Ye(n,["attributs"]);return He(He({},t),{},{[e]:He(He({},a),r)})})},t);return He(He({},i),{},{visualisationKind:"composantes"})})(r,o,n):(null==o?void 0:o.variations)&&Object.values(o).length>1?((e,n,t)=>{if("valeur"===e)return Zt(n,t);var{variations:r}=n,a=xt(n,["variations"]);return Zt({variations:r.map(n=>{var{alors:t,sinon:r,si:i}=n,o=null!=t?t:r,{attributs:u}=o,l=xt(o,["attributs"]);return ht({[void 0!==t?"alors":"sinon"]:ht(ht({},u),{},{[e]:ht(ht({},a),l)})},void 0!==i&&{si:i})})},t)})(r,o,n):u(o,n)}catch(e){if(e instanceof a)throw e;i(n.dottedName,r?"➡️ Dans le mécanisme ".concat(r,"\n").concat(e.message):e.message)}}var Yt=[Ke,hn,An,Me,bt,In,Un,qe,it];var Qt=Bt(Bt(Bt({},En),Yt.reduce((e,n)=>Bt({[n.nom]:n},e),{})),{},{"une possibilité":(e,n)=>(Array.isArray(e)&&(e={"possibilités":e}),xn(xn({},e),{},{explanation:e.possibilités.map(e=>Zt(e,n)),nodeKind:"une possibilité",context:n.dottedName})),"inversion numérique":(e,n)=>{if(!e.avec)throw new Error("Une formule d'inversion doit préciser _avec_ quoi on peut inverser la variable");return bn(bn({explanation:{ruleToInverse:n.dottedName,inversionCandidates:e.avec.map(e=>Zt(e,n))}},"unité"in e&&{unit:J(e.unité,n.getUnitKey)}),{},{nodeKind:"inversion"})},recalcul:(e,n)=>{var t,r=Object.keys(e.avec).map(t=>[Zt(t,n),Zt(e.avec[t],n)]),a=n.dottedName;return{explanation:{recalcul:Zt(null!==(t=e.règle)&&void 0!==t?t:a,n),amendedSituation:r},nodeKind:"recalcul"}},variable:function(e,n){return{nodeKind:"reference",name:e,contextDottedName:n.dottedName}},"une de ces conditions":(e,n)=>{if(!Array.isArray(e))throw new Error("should be array");return{explanation:e.map(e=>Zt(e,n)),nodeKind:"une de ces conditions"}},"toutes ces conditions":(e,n)=>{if(!Array.isArray(e))throw new Error("should be array");return{explanation:e.map(e=>Zt(e,n)),nodeKind:"toutes ces conditions"}},somme:(e,n)=>({explanation:e.map(e=>Zt(e,n)),nodeKind:"somme"}),multiplication:zn,produit:zn,temporalValue:function(e,n){var t=Zt(e.explanation,n);return{nodeKind:"variable temporelle",explanation:{period:{start:e.period.start&&Zt(e.period.start,n),end:e.period.end&&Zt(e.period.end,n)},value:t}}},"barème":function(e,n){return{explanation:{assiette:Zt(e.assiette,n),multiplicateur:e.multiplicateur?Zt(e.multiplicateur,n):Ve(1),tranches:Fe(e.tranches,n)},nodeKind:"barème"}},grille:function(e,n){return{explanation:{assiette:Zt(e.assiette,n),multiplicateur:e.multiplicateur?Zt(e.multiplicateur,n):Ve(1),tranches:Fe(e.tranches,n)},nodeKind:"grille"}},"taux progressif":function(e,n){return{explanation:{assiette:Zt(e.assiette,n),multiplicateur:e.multiplicateur?Zt(e.multiplicateur,n):Ve(1),tranches:Fe(e.tranches,n)},nodeKind:"taux progressif"}},"durée":(e,n)=>({explanation:De(cn,e,n),unit:J("jour"),nodeKind:"durée"}),"le maximum de":(e,n)=>({explanation:e.map(e=>Zt(e,n)),nodeKind:"maximum"}),"le minimum de":(e,n)=>({explanation:e.map(e=>Zt(e,n)),nodeKind:"minimum"}),variations:function(e,n){return{explanation:e.map(e=>{var{si:t,alors:r,sinon:a}=e;return void 0!==a?{consequence:Zt(a,n),condition:Ve(!0)}:{consequence:Zt(r,n),condition:Zt(t,n)}}),nodeKind:"variations"}},synchronisation:(e,n)=>({explanation:ut(ut({},e),{},{data:Zt(e.data,n)}),nodeKind:"synchronisation"}),valeur:Zt,objet:e=>({type:"objet",nodeValue:e,nodeKind:"constant"}),constant:e=>({type:e.type,fullPrecision:!0,nodeValue:e.nodeValue,nodeKind:"constant"})}),Xt=Object.keys(Qt),er=t(6),nr=t.n(er);function tr(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function rr(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?tr(Object(t),!0).forEach((function(n){ar(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):tr(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function ar(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function ir(e){var n,t,r,a,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o="string"==typeof e?nr.a.parse((""+e).replace(/\t/g,"  ")):rr({},e);o=or(o);var u={dottedName:null!==(n=i.dottedName)&&void 0!==n?n:"",parsedRules:null!==(t=i.parsedRules)&&void 0!==t?t:{},logger:null!==(r=i.logger)&&void 0!==r?r:console,getUnitKey:null!==(a=i.getUnitKey)&&void 0!==a?a:e=>e};Object.entries(o).forEach(e=>{var[n,t]=e;null==t&&(t={}),"object"!=typeof t&&(t={formule:""+t}),Zt(rr({nom:n},t),u)});var l=u.parsedRules,s=At(l=m(ur(l),l));return l=m(Kt(s,u.logger),l)}function or(e){return Array.isArray(e)?e.map(or):e&&"object"==typeof e?Object.entries(e).reduce((e,n)=>{var t,[r,a]=n,i=/\[ref( (.+))?\]$/.exec(r);if(!i)return rr(rr({},e),{},{[r]:or(a)});var o=r.replace(i[0],"").trim(),u=(null===(t=i[2])||void 0===t?void 0:t.trim())||o;return rr(rr({},e),{},{[o]:{nom:u,valeur:or(a)}})},{}):e}var ur=e=>p(n=>{if("reference"===n.nodeKind){var t=Yn(e,n.contextDottedName,n.name);return rr(rr({},n),{},{dottedName:t,title:e[t].title,acronym:e[t].rawNode.acronyme})}}),lr=t(4),sr=t.n(lr);function cr(e){if("number"==typeof e.nodeValue){var n=H(e.unit);return""+e.nodeValue+(n?n.replace(/\s/g,""):"")}return"boolean"==typeof e.nodeValue?e.nodeValue?"oui":"non":"string"==typeof e.nodeValue?"'".concat(e.nodeValue,"'"):void 0}function pr(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function dr(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?pr(Object(t),!0).forEach((function(n){mr(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):pr(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function mr(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}var fr=()=>({_meta:{ruleStack:[]},nodes:new Map});class br{constructor(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};mr(this,"parsedRules",void 0),mr(this,"parsedSituation",{}),mr(this,"replacements",{}),mr(this,"cache",fr()),mr(this,"options",void 0),this.options=dr(dr({},t),{},{logger:null!==(e=t.logger)&&void 0!==e?e:console}),"string"==typeof n&&(n=ir(n,this.options));var r=Object.values(n)[0];"object"==typeof r&&null!=r&&"nodeKind"in r||(n=ir(n,this.options)),this.parsedRules=n,this.replacements=At(this.parsedRules)}setOptions(e){this.options=dr(dr({},this.options),e)}resetCache(){this.cache=fr()}setSituation(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.resetCache(),this.parsedSituation=Object.fromEntries(Object.entries(e).map(e=>{var[n,t]=e;return t&&"object"==typeof t&&"nodeKind"in t?[n,t]:[n,t&&"object"==typeof t&&"nodeKind"in t?t:this.parse(t,dr({dottedName:"situation [".concat(n,"]"),parsedRules:{}},this.options))]})),this}parse(){return Kt(this.replacements,this.options.logger)(ur(this.parsedRules)(Zt(...arguments)))}inversionFail(){return!!this.cache._meta.inversionFail}getRule(e){if(!(e in this.parsedRules))throw new Error("La règle '".concat(e,"' n'existe pas"));return this.parsedRules[e]}getParsedRules(){return this.parsedRules}evaluate(e){var n,t=this.cache.nodes.get(e);if(void 0!==t)return t;if(n=e&&"object"==typeof e&&"nodeKind"in e?e:this.parse(e,dr({dottedName:"evaluation",parsedRules:{}},this.options)),!L[n.nodeKind])throw Error('Unknown "nodeKind": '.concat(n.nodeKind));var r=L[n.nodeKind].call(this,n);return this.cache.nodes.set(e,r),r}}function vr(e,n){var t=e.getRule(n);return d((function(r,a,i){return r||("nodeValue"in a?"variations"===a.nodeKind?a.explanation.some(e=>{var{consequence:t}=e;return i(t)||!1===t.nodeValue&&t.dottedName!==n}):"reference"===a.nodeKind&&a.dottedName===n?i(e.evaluate(t)):"applicable si"===a.nodeKind?!1===a.explanation.condition.nodeValue||i(a.explanation.valeur):"non applicable si"===a.nodeKind?!1!==a.explanation.condition.nodeValue&&null!==a.explanation.condition.nodeValue:"rule"===a.nodeKind?!1===a.explanation.parent.nodeValue||i(a.explanation.valeur):void 0:r)}),!1,e.evaluate(n))}}])}));